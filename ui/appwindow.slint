import { Cell } from "cell.slint";
import { TurnInfo } from "turninfo.slint";
import { HorizontalBox, VerticalBox } from "std-widgets.slint";

struct GamePieceData {
    marker: string,
    marker-color: color
}

export component AppWindow inherits Window {

    in-out property <string> current-player: "X";
    in property <bool> is-game-over: false;
    in property <[GamePieceData]> board: [
            { marker: "" },
            { marker: "" },
            { marker: "" },
            { marker: "" },
            { marker: "" },
            { marker: "" },
            { marker: "" },
            { marker: "" },
            { marker: "" }
        ];

    callback check-if-game-over();
    callback restart-game();

    private property <length> cell-spacing: 10px;
    private property <length> cell-size: 150px;
    private property <int> row-count: 3;
    private property <int> column-count: 3;
    private property <color> marker-color: red;
    // Calculate the total width and height of the grid.
    private property <length> game-board-width: (column-count * cell-size) + ((column-count + 1) * cell-spacing);
    private property <length> game-board-height: (row-count * cell-size) + ((row-count + 1) * cell-spacing);

    title: "Tic Tac Toe";
    background: #313e50;
    width: game-board-width;
    height: game-board-height + 50px;

    for cell[i] in board: Cell {
        clicked => {
            if (cell.marker == "" && !is-game-over) {
                cell.marker = current-player;
                cell.marker-color = root.marker-color;
                root.current-player = root.current-player == "X" ? "O" : "X";
                root.check-if-game-over();
            }
        }
        // Calculate the centering offsets (x, y) for the cell.
        x: root.cell-spacing + mod(i, root.column-count) * (root.cell-size + root.cell-spacing);
        y: root.cell-spacing + floor(i / root.row-count) * (root.cell-size + root.cell-spacing);

        width: root.cell-size;
        height: root.cell-size;

        marker: cell.marker;
        marker-color: cell.marker-color;
    }

    HorizontalBox {
        Text {
            text: "Restart";
            color: red;
            vertical-alignment: bottom;
            font-size: 20px;
            TouchArea {
                clicked => { root.restart-game(); }
            }
        }
        alignment: start;
    }

    HorizontalBox {
        Text {
            text: !root.is-game-over ? (root.current-player + " Turn") : "Game Over!";
            color: red;
            vertical-alignment: bottom;
            font-size: 20px;
        }
        alignment: end;
    }

    HorizontalBox {
        VerticalLayout{
            TurnInfo {
                rect-x: !is-game-over && root.current-player == "O" ? 9px : -50px;
            }
            alignment: end;
            padding-bottom: 40px;
        }
        alignment: center;
    }

    HorizontalBox {
        Text {
            text: "X        O";
            color: black;
            vertical-alignment: bottom;
            font-size: 20px;
            font-weight: 700;
        }
        alignment: center;
    }
}